### Итоговый проект по курсу "PostgreSQL для администраторов баз данных и разработчиков" ###  
## Тема: "Создание БД для проекта "Интернет-магазин книг" и тестирование его работы с использованием pgbench" ##   
### Первая часть проекта заключалась в разработке минимальной БД в PostgreSQL. ###   
Была разработана схема БД по теме "Интернет-магазин книг". Схема содержит 5 базовых таблиц:  
 - Книги  
 - Склады  
 - Покупатели  
 - Номенклатура продаж (отражает наличие книг на складах, в зависимости от склада книга может иметь разную стоимость и срок доставки)   
 - Заказы   
Также в схеме есть две витрины данных, автоматически заполняемых триггерами по данным базовых таблиц:  
 - Наличие книг  
 - Итоги продаж  
![Логическая схема](/Scripts/Schema_log.jpg)
Этапы разработки:   
[1. Физическая схема](https://github.com/mkalinichenko2023/otus_project/tree/main/Scripts/Schema_fiz.jpg)   
[2. Скрипты создания таблиц схемы](https://github.com/mkalinichenko2023/otus_project/tree/main/Scripts/Create%20DB%20script.txt)   
[3. Скрины создания таблиц схемы](https://github.com/mkalinichenko2023/otus_project/tree/main/Screens/Create%20DB%20screens.md)   
[4. Создание триггерных функций для поддержания витрин в актуальном состоянии](https://github.com/mkalinichenko2023/otus_project/tree/main/Scripts/Add%20functions.txt)   
[5. Скрины триггерных функций для поддержания витрин в актуальном состоянии](https://github.com/mkalinichenko2023/otus_project/tree/main/Screens/Create%20DopFunc.md)   
[6. Заполнила основные таблицы схемы данными (сделала обычную вставку, загрузку готовых списков и генерацию случайных данных с учетом назначения таблиц)](https://github.com/mkalinichenko2023/otus_project/tree/main/Scripts/Load%20data.txt)   
[7. Скрины заполнения основные таблицы схемы данными](https://github.com/mkalinichenko2023/otus_project/tree/main/Screens/Create%20LoadData.md)   
***Итог: Выполненная работа позволила закрепить полученную на курсе информацию по созданию различных объектов БД в PostgreSQL, а также подсветила отличия в работе с PostgreSQL и с СУБД Oracle.***
------------------------   
### Вторая часть проекта заключалась в изучении pgbench. ###   
По умолчанию программа pgbench может создавать 4 таблицы (pgbench_accounts, pgbench_branches, pgbench_history и pgbench_tellers), заполнять их данными и прогонять скрипт типа TPC-B для оценки производительности системы.   
Но pgbench также позволяет задавать свои собственные скрипты тестирования. Скрипты можно написать на основе своих задач, что позволит более точно оценить производительность конкретной системы с учетом особенностей ее схемы базы данных.   
Описание ключей для вызова pgbench с собственным тестовым сценарием можно посмотреть [здесь](https://github.com/mkalinichenko2023/otus_project/tree/main/Scripts/pgbench_info.md)    
Для разработанной схемы "Интернет-магазин книг" сделала три тестовых скрипта для тестирования наиболее встречающихся массовых операций:   
1. Создание нового заказа.   
![Скрипт 1](/Screens/test_file_1.jpg)   
Скрипт вызывает функцию создания заказа:   
![Функция 1](/Screens/function_test_1.jpg)   
Вызов скрипта тестирования:   
![Тест 1](/Screens/test1_1.jpg)   
![Тест 1](/Screens/test1_2.jpg)   
По скринам видно, что при повторении теста за те же 2 минуты выросло количество выполненных транзакций и показатель tps.  
1. Инвентаризация наличия книг на складе.   
![Скрипт 2](/Screens/test_file_2.jpg)   
Скрипт вызывает функцию изменения таблицы "номенклатура продаж":   
![Функция 2](/Screens/function_test_2.jpg)   
Вызов скрипта тестирования:   
![Тест 2](/Screens/test2_1.jpg)   
![Тест 2](/Screens/test2_2.jpg)   
По скринам видно, что при повторении теста также выросло количество выполненных транзакций и показатель tps.  
1. Поиск книги и получение подробной информации по стоимости и времени доставки в зависимости от склада.   
![Скрипт 3](/Screens/test_file_3.jpg)   
Скрипт вызывает функцию поиска книги:   
![Функция 3](/Screens/function_test_3.jpg)   
Вызов скрипта тестирования:   
![Тест 3](/Screens/test3_1.jpg)   
![Тест 3](/Screens/test3_2.jpg)   
По скринам видно, что при повторении теста показатели тестирования существенно не поменялись.  
Самый медленный тест получился по инвентаризации наличия книг на складе, т.е. по обновлению таблицы "номенклатура продаж". На данной таблице висят триггеры, которые обеспечивают заполнение "витрины наличия книг". Для оценки влияния их работы на общую скорость отключила триггер trOnUpdateProducts (на update таблицы Products).
![Тест 3](/Screens/drop_trigger.jpg)   
Запустила тестирование pgbench по скрипту 2 с отключенным триггером:   
![Тест 3](/Screens/test_trigger.jpg)   
![Тест 3](/Screens/test_trigger2.jpg)  
Оба теста при выключенном триггере показали примерно одинаковый результат улучшения производительности примерно на 20%.   
Посмотрела параметры PostgreSQL в файле /etc/postgresql/15/main/postgresql.conf. Попробовала изменить настройки системы:  
![Тест 3](/Screens/new_settings2.jpg)   
![Тест 3](/Screens/new_settings.jpg)   
***shared_buffers*** - используется для кеширования данных, чем больше данных в памяти, тем выше скорость.   
***work_mem*** - используется для сортировок, построения hash таблиц, увеличение размера позволяет выполнять данные операции в памяти, что также повышает скорость.   
***random_page_cost*** - определяет стоимость, которую будет иметь страница диска с непоследовательной выборкой, и напрямую влияет на решения планировщика запросов. Т.к. у нас SSD диск, то можно поставить 1. ***min_wal_size, max_wal_size*** - управляют контрольными точками, изменила параметры так, чтобы растянуть время между контрольными точками, уменьшить запись изменений во время теста, снизить нагрузку на дисковую подсистему.  
Изменив вышеперечисленные настройки, запустила тестирование pgbench тесте 1 "создание нового заказа":   
![Тест 3](/Screens/test1_1_add.jpg)   
Изменив настройки системы для работы с памятью по умолчанию, по тесту 1 один мы получили повышение производительности примерно на 20% для операции добавления новых данных.  
Проверила производительность системы при тестировании pgbench тесте 2 по обновлению таблицы "номенклатура продаж":   
![Тест 3](/Screens/test2_1_add.jpg)   
По результатам теста видно, что произведенные настройки системы не оказали существенного влияния на тест по обновлению таблицы "номенклатура продаж".    
***Итог: Выполненная работа позволила более подробно познакомиться с pgbench, изучить особенности ее применения для тестирования конкретных схем данных***   
